# ПОГОДНЫЙ СВЕТИЛЬНИК
# Аннотация
На примере данного проекта я хочу продемонстрировать **методику системной разработки изделия** по полному циклу от осознания потребности до проверки результата, которая является частью создаваемой мной **методики системной разработки продукта**. Методика призвана помочь разработчику "не двигаться вслепую" к результату, а чтобы результат был закономерен и ожидаем. В качестве примера разработаем полезный в хозяйстве предмет.
Исходники для повторения проекта прикреплены в конце статьи.

**Спойлер**: разработанное изделие:

<img width="303" height="400" alt="Погодный светильник (готовый)" src="https://github.com/user-attachments/assets/72c21646-40b6-45ea-a0da-6d392af54945" />

[1. Выявление потребности](#1. Выявление потребности)

# 1. Выявление потребности
## 1.1 Интервью с аудиторией, наблюдения, анализ "болей"
Часто я выхожу из дома, не получив и/или не отреагировав на информацию о погоде на день. Итог: попадаю под дождь без зонта или при снегопаде не имею запаса по времени на очистку авто от снега.
Мне необходимо утром, непосредственно перед тем как я выйду на работу, узнать, будут ли осадки до того как я вернусь с работы домой. 
## 1.2 Анализ существующих решений

| Источник информации    | <font color="#00b050">Плюсы</font>                                                         | <font color="#ff0000">Минусы</font>                              |
| ---------------------- | ------------------------------------------------------------------------------------------ | ---------------------------------------------------------------- |
| в интернете с телефона | высокая точность прогноза, есть несколько независимых источников, легко получить результат | забываю проверить                                                |
| фитнес-браслет         | легко получить результат                                                                   | низкая точность прогноза, всего один источник, забываю проверить |
| Яндекс станция         | очень легко получить результат, не забываю проверить                                       | низкая точность прогноза, всего один источник                    |

## 1.3 Определение основного функционала изделия
Изделие должно давать информацию о вероятности осадков:
- точно
- стабильно
- своевременно
- не требовать усилий для получения
- правильно интерпретироваться
- требовать минимум обслуживания и усилий по поддержанию работоспособности

# 2. Технические требования к изделию
## 2.1 Определение второстепенного функционала
Изделие должно быть:
- безопасным
- прочным, стабильным, надежным, долговечным
- компактным
- способ донесения информации должен быть ненавязчивым (не вызывать негативных реакций)
- иметь эстетический внешний вид, приятный дизайн
- иметь малое энергопотребление

## 2.2 Определение ограничений изделия
Ограничения:
- себестоимость не более 1500р
- трудоемкость (изготовление от и до) не более 16 часов
- изготовление своими руками без привлечения сторонних специалистов/компаний

## 2.3 Иерархия требований
1. **Безопасность** (1...5 баллов):
	- Физическая безопасность для пользователя (отсутствие возможности пораниться, удариться, защемить пальцы, застрять пальцами, невозможно обжечься, невозможно получить удар током) - 5 баллов
	- Гипоаллергенные, химически безопасные материалы наружных поверхностей - 5 баллов
	- Пожаробезопасность - 5 баллов
2. **Функциональность** (1...4 балла):
	- Точность отображаемой информации - 3 балла
	- Стабильность получения информации - 4 балла
	- Своевременность получения информации - 4 балла
	- Простота получения информации (минимум действий пользователя) - 4 балла
	- Простота интерпретации информации - 3 балла
	- Малое энергопотребление - 1 балл
	- Ненавязчивость (не напоминает о себе когда не требуется) - 1 балл
3. **Прочность** (1...4 балла):
	- Физическая (прочность, выносливость конструкции) - 4 балла
	- Электрическая (устойчивость к сбоям в сети, надежность схемы, надежность подключения(й)) - 4 балла
4. **Надежность** (1...4 балла):
	- Простота устранения неисправности - 2 балла
	- Быстрое восстановление после сбоя - 1 балл
	- Долговечность - 3 балла
5. **Дизайн/эстетика** (1...4 балла):
	- Эстетический внешний вид - 2 балла
	- Дизайн изделия вписывается в окружение - 2 балла
6. **Эргономичность** (1...3 балла):
	- Получение информации происходит естественно (в естественной для человека позе) - 3 балла
7. **Простота обслуживания и ввода в эксплуатацию** (1...4 балла):
	- Автономность (отсутствие необходимости обслуживания или поддержания работоспособности) - 4 балла
	- Легко вытереть пыль с изделия (помыть) - 2 балла
	- Монтаж не требует сложных действий - 1 балл
8. **Компактность, мобильность** (1...2 балла):
	- Изделие можно перенести и эксплуатировать в другом месте - 1 балл
	- Изделие легко переместить при уборке помещения - 1 балл

## 2.4 Определение целевых параметров изделия
Изделие будет питаться от типового зарядного блока питания 5 В, выключаться и включаться автоматически, не требовать регулярных денежных вложений при эксплуатации. 
Периоды, для которых мне необходимо знать вероятность осадков: 
- 0-1 час (путь из дома на работу), 
- 4-5 часов (обеденное время), 
- 9-10 часов (путь с работы домой).

Наружные поверхности изделия не должно нагреваться выше 40 градусов.
Корпус изделия должен быть либо покупной, либо должен быть изготовлен самостоятельно.
# 3. Разработка концепта
## 3.1 Генерация нескольких концептов
### Концепт 1: погодный светильник
Изделие представляет собой небольшой светильник, у которого цвет свечения напрямую связан с вероятностью осадков в ближайшие несколько часов. Использован принцип светофора, где зеленый цвет сигнализирует о нулевой вероятности, а красный о максимальной. Промежуточные значения цвета соответствуют промежуточным значениям вероятностей:

<img width="600" height="600" alt="Погодная шкала" src="https://github.com/user-attachments/assets/303be226-3516-40cc-8877-5c736b208a15" />

Плюсы:
- Красивый способ предоставления информации (люблю свет насыщенного цвета).
- Цельный образ изделия (светильник, испускающий свет, внутри которого спрятана вся электроника).

Минусы:
- Нет возможности разделить информацию по периодам времени - она суммируется за 9-10 часов (не смогу узнать, когда именно будут осадки).
- Невысокая точность информации (я различаю мало оттенков цвета).

---

### Концепт 2: настенный стрелочный индикатор
Концепт аналогичен первому, но представляет из себя шкалу со стрелкой, например:

<img width="400" height="400" alt="Погодная шкала" src="https://github.com/user-attachments/assets/5b838009-1d13-4995-8407-79189dc0b99a" />

Плюсы:
- Предельно интуитивный способ представления информации.
- Высокая точность информации.
- Цельный образ изделия (стрелочный датчик, висящий на стене).

Минусы:
- Нет возможности разделить информацию по периодам времени - она суммируется за 9-10 часов (не смогу узнать, когда именно будут осадки).
- Плохо притягивает к себе внимание, можно забыть посмотреть.
- Понадобится тянуть кабель к изделию по стене.

---

### Концепт 3: полезный в коридоре предмет с встроенными цифровыми индикаторами
Изделие представляет собой тарелку для мелочи/ключей, стакан для ручек, подставку, фоторамку или иной полезный в коридоре предмет, в который встроены три светящихся цифровых индикатора, либо один экран с выводом трех значений вероятности осадков в указанные периоды времени:

<img width="400" height="400" alt="Концепт с встроенными индикаторами" src="https://github.com/user-attachments/assets/6c585fd1-2901-478d-b752-789ac0e9fbad" />

Плюсы:
- Интуитивный способ представления информации.
- Высокая точность информации.
- Цельный образ изделия.
- Возможно использовать как полезный в коридоре предмет: подставка, емкость для хранения и т.д.
- Информация об осадках предоставляется за каждый период времени в отдельности.
- Есть настройка периодов времени (если изменился распорядок дня).

Минусы:
- Временные периоды в выходные нужно настраивать отдельно, иначе информация почти бесполезна.
## 3.2 DFMEA-анализ
Выполним <u>упрощенную</u> версию DFMEA, т.к. изделие не серийное и контроль качества будет выполнен на 100%.
Общие для всех концептов потенциальные дефекты:

| Вид потенц. дефекта                                                                                          | Последствия                                                                             | Значимость                           | Способы предупреждения                                                                                                                 |
| ------------------------------------------------------------------------------------------------------------ | --------------------------------------------------------------------------------------- | ------------------------------------ | -------------------------------------------------------------------------------------------------------------------------------------- |
| Острые кромки, заусенцы и т.д. на внешних поверхностях                                                       | Травмы, порезы, уколы                                                                   | <font color="#ff0000">Высокая</font> | Скругление острых кромок и углов, механическая обработка заусенцев и пр.                                                               |
| Перегрев (наружных и внутренних поверхностей)                                                                | Ожоги, возгорание                                                                       | <font color="#ff0000">Высокая</font> | Нагрев наружных поверхностей не выше 50 градусов, а внутренних не выше 60 градусов.                                                    |
| Открытые токоведущие части                                                                                   | Ожоги, поражения нервной и сердечно-сосудистой системы                                  | <font color="#ff0000">Высокая</font> | Питание изделия безопасным напряжением, сетевое напряжение изолировано от доступа пользователя, токоведущие части скрыты под корпусом. |
| Высокая химическая активность наружных поверхностей                                                          | Химические поражения, аллергические реакции                                             | <font color="#ff0000">Высокая</font> | Наружные поверхности выполнены из безопасных материалов.                                                                               |
| Низкая скорость работы всего изделия                                                                         | Долгое ожидание информации                                                              | <font color="#ffff00">Низкая</font>  | Включение, получение и отображение информации должно происходить заранее, до того как она понадобится пользователю.                    |
| Нечеткость, нечитаемость информации                                                                          | Потеря времени и внимания на то, чтобы "рассмотреть" информацию                         | <font color="#ffc000">Средняя</font> | Информация должна быть видна и читаема с той точки, с которой предполагается ее получать. Отвлечение внимания не допустимо.            |
| Хрупкость конструкции                                                                                        | Разрушение изделия, полная или частичная потеря работоспособности                       | <font color="#ff0000">Высокая</font> | Корпус и электроника должны выдерживать падение с высоты установки, неаккуратное обращение, грубое выдергивание кабеля питания и т.д.  |
| Нестабильность системы (отвалы сети, мерцание/колебания источника информации, посторонние звуки, шум и т.д.) | Отвлечение внимания,  отсутствие уверенности в актуальности полученной информации       | <font color="#ffc000">Средняя</font> | В месте эксплуатации изделие работает стабильно, предсказуемо, ненавязчиво.                                                            |
| Неремонто-пригодность                                                                                        | Невозможность отремонтировать изделие, заменить комплектующие без замены других деталей | <font color="#ffc000">Средняя</font> | Изделие должно легко разбираться и собираться без поломок других деталей. Доступ должен быть обеспечен ко всем элементам.              |
| Дизайн не вписывается в окружение                                                                            | Негативные эмоции от эксплуатации изделия                                               | <font color="#ffff00">Низкая</font>  | Перед проектированием  подставить рендер концепта на фото с предполагаемым местом эксплуатации.                                        |

## 3.3 Выбор основных комплектующих и технологий изготовления
**Общие**:
- **Корпус** предполагается изготавливать с применением 3D-печати пластиком PETG (гипоаллергенность, химическая безопасность).  Корпус будет разбиваемым с возможностью добраться до электроники.
- **Электроника** будет в виде отдельных модулей, соединенных между собой кабелями с разъемами. Контроллер должен иметь встроенный Wi-fi.
- **Прошивка** будет выполнена на языке C.

**Концепт 1**: в качестве **источника цвета** будет использовано кольцо LED, состоящее из светодиодов WS2812.

**Концепт 2**: в качестве **стрелочного индикатора** предполагается использовать готовый модуль, заменив ему шкалу (к сожалению, готовые стрелочные индикаторы с процентной шкалой - уникальная редкость):

<img width="300" height="300" alt="Стрелочный индикатор" src="https://github.com/user-attachments/assets/0a2fd210-d502-43ff-af83-c4b1a4bd4b5e" />

Его применение удобно тем, что выбрав его модель на рабочее напряжение равное рабочему напряжению контроллера, управлять стрелкой можно с помощью ШИМ-сигнала.

**Концепт 3**: в качестве **цифровых индикаторов** предполагается использовать сдвоенные семисегментные светодиодные индикаторы:

<img width="128" height="200" alt="Сдвоенный семисегментный индикатор" src="https://github.com/user-attachments/assets/d28df578-83d2-41c5-ac46-ca8fed40ff5e" />

Для подключения трех таких индикаторов понадобилось бы 7х2х3=42 цифровых пина контроллера. В связи с дороговизной подобных контроллеров и сложностью подключений (дополнительно понадобился бы токоограничивающий резистор на каждый пин) необходимо использовать **драйвер MAX7219** или аналог.
Дополнительно необходимо снабдить изделие возможностью регулировки временных периодов, для которых выводится вероятность осадков. Проще всего это реализовать с помощью кнопок: по две кнопки возле каждого индикатора, нажатие на верхнюю увеличивает период, на нижнюю - уменьшает. На соответствующем индикаторе при нажатии кнопок отображается значение выбранного периода.
## 3.4 Оценка себестоимости и трудоемкости изготовления концептов
**Концепт 1** (погодный светильник):
- Контроллер ESP-01s (57 р) - 1 шт.
- Модуль LED для ESP-01s (72 р) - 1 шт.
- Кольцо LED из 45 светодиодов WS2812 (369 р) - 1 шт.
- Пластик PETG белый (в среднем 820 р/кг) - около 65 грамм.
- Пластик PETG прозрачный (в среднем 820 р/кг) - около 4,5 грамм.
- Гнездо USB-C белое мама (50 р) - 1 шт.
- Программатор CH340G для ESP-01s (62 р) - 1 шт.

Итого предварительная **себестоимость** без учета расходников составит: 57 + 72 + 369 + 820 х 0,065 + 820 х 0,0045 + 50 + 62 = **667 р**
**Трудоемкость** изготовления <u>ниже среднего</u>: сложная форма корпуса, но очень простое электрическое подключение (все на разъемах, минимум пайки).

---

**Концепт 2** (настенный стрелочный индикатор):
- Контроллер ESP-01s (57 р) - 1 шт.
- Стабилизатор питания 3,3 В (30 р) - 1 шт.
- Стрелочный индикатор 3 В (113 р) - 1 шт.
- Пластик PETG белый (в среднем 820 р/кг) - около 65 грамм.
- Гнездо USB-C белое мама (50 р) - 1 шт.
- Программатор CH340G для ESP-01s (62 р) - 1 шт.
- Макетная (прототипная) плата (60 р) - 1 шт.

Итого предварительная **себестоимость** без учета расходников составит: 57 + 30 + 113 + 820 х 0,065 + 50 + 62 + 60 = **625 р**
**Трудоемкость** изготовления <u>выше среднего</u>: схему необходимо спаять на макетной (прототипной) плате, требуется доработка индикатора.

---

**Концепт 3** (полезный в коридоре предмет с встроенными цифровыми индикаторами):
- Контроллер ESP8622 (120 р) - 1 шт.
- Сдвоенный семисегментный индикатор (20 р) - 3 шт.
- Драйвер MAX7219 (50 р) - 1 шт. Микросхему сложно найти отдельно, не в составе светодиодных матриц.
- Кнопка (4 р) - 6 шт.
- Пластик PETG белый (в среднем 820 р/кг) - около 100 грамм.
- Гнездо USB-C белое мама (50 р) - 1 шт.
- Макетная (прототипная) плата (60 р) - 1 шт.

Итого предварительная **себестоимость** без учета расходников составит: 120 + 20 х 3 + 50 + 4 х 6 + 820 х 0,1 + 50 + 60 = **451 р**
**Трудоемкость** изготовления <u>высокая</u>: схему необходимо спаять на макетной (прототипной) плате, много пайки дорожек, может быть сложно найти микросхему-драйвер, самый сложный код для контроллера.

---

## 3.5 Выбор наилучшего концепта
Сравнительная оценка (1, 3 или 9 баллов):

| Концепт                                              | <font color="#00b050">Плюсы</font> | <font color="#ff0000">Минусы</font> | Себе-стоимость | Трудо-емкость | Итоговая оценка *(произведение баллов)* |
| ---------------------------------------------------- | ---------------------------------- | ----------------------------------- | -------------- | ------------- | --------------------------------------- |
| Погодный светильник                                  | 9                                  | 3                                   | 1              | 9             | 243                                     |
| Настенный стрелочный индикатор                       | 1                                  | 1                                   | 1              | 3             | 3                                       |
| Полезный в коридоре предмет с цифровыми индикаторами | 9                                  | 9                                   | 3              | 1             | 243                                     |

> [!Примечание]
> Плюсы и минусы оцениваются суммарно по шкале 1, 3 или 9 баллов - чем оценка выше, тем преимущества и недостатки существенней (например, у концепта с оценкой плюсов 9 балла означает самую высокую полезность среди прочих, а оценка минусов 9 балла означает самые **низкие** издержки работы концепта). Это означает, что чем **выше балл**, тем концепт **более предпочтителен**.

В качестве итогового концепта выбран **погодный светильник** из-за более простой реализации.

> [!Примечание]
> У меня было в наличии подходящее светодиодное кольцо, модуль LED, контроллер ESP-01s и программатор, из-за чего затраты на изготовление этого концепта составляли всего 107 р.

# 4. Тестирование концепта продукта
Сгенерируем внешний вид изделия. Промт: "*Белый настольный пластиковый светильник с футуристичным дизайном и лампой в виде тонкого кольца*". Перебрав около 50 вариантов, я остановился на следующих:

<img width="600" height="600" alt="Погодный светильник (Гигачат 1)" src="https://github.com/user-attachments/assets/12e38898-955b-4187-8072-9f88ba689eb4" />
<img width="600" height="600" alt="Погодный светильник (Гигачат 2)" src="https://github.com/user-attachments/assets/e14cf323-f041-4fc2-b912-84755a912115" />
<img width="600" height="600" alt="Погодный светильник (Гигачат 3)" src="https://github.com/user-attachments/assets/bb1c3025-b605-47b7-9951-e9ec1671a3dc" />

Представляем как он будет выглядеть в месте эксплуатации:

<img width="800" height="800" alt="Погодный светильник в коридоре" src="https://github.com/user-attachments/assets/84382b39-8af8-4b37-aaa8-1205ed9df0e5" />

На этом этапе можно поставить обычную настольную лампу и представить как она светит ярким насыщенным светом, предупреждая об осадках. Не помешает ли она здесь? Будет ли ее свет улавливаться периферией взгляда? Какая яркость будет для нее здесь оптимальной? Чем на большее количество вопросов, связанных с конструкцией, принципом работы и особенностей эксплуатации мы ответим сейчас, тем более качественное изделие сможем получить в конце проекта.
**Важно отметить**, что в данном случае продуктом является не само изделие, а ценность, которую мы приобретаем. Продуктом будет коридор с цветовой индикацией погоды, а светильник - лишь часть этого продукта. Поэтому необходимо заранее продумать, будет ли весь продукт работать как нужно? Не возникнет ли новых сложностей и будет ли ценность реализована в полной мере?
==**Концепт признан годным**.==
# 5. Архитектура изделия
## 5.1 Функциональная схема изделия в виде взаимодействующих блоков и интерфейсов

<img width="500" height="323" alt="Погодный светильник (структурная схема2)" src="https://github.com/user-attachments/assets/ab0b20ab-44b5-4082-8047-87fc37c16e46" />

## 5.2 Компоновка и эскиз изделия
Эскиз будущего изделия:

<img width="1187" height="565" alt="Погодный светильник (эскиз)" src="https://github.com/user-attachments/assets/66df16d2-2c20-4bda-ac2c-63fc52134329" />

> [!Примечание]
> От переключателя в последствии было решено отказаться, так как для включение и выключение светильника предполагается посредством включения в "умную" розетку.
# 6. Создание и тестирование прототипа (валидация)
## Шаг 1: разработка прошивки контроллера
В качестве среды разработки прошивки для контроллера будем использовать Arduino IDE, а данные о погоде будем получать в формате JSON с ресурса https://openweathermap.org/, т.к. большинство аналогов - платные. Нам необходимо на нем зарегистрироваться и получить API-ключ:

<img width="1352" height="473" alt="Погодный светильник (получение API-ключа)" src="https://github.com/user-attachments/assets/61524a71-2881-45df-8b66-ac3528c13e9e" />

Код для ESP-01s:
```
#include <ESP8266WiFi.h>
#include <ESP8266HTTPClient.h>
#include <Adafruit_NeoPixel.h>
#include <ArduinoJson.h>

#define LED_PIN 2 // GPIO2
#define LED_COUNT 45 // количество светодиодов
#define BRIGHTNESS 200 // Яркость светодиодов, макс 255
#define NUMBER_OF_REQUESTS 1 // Количество запросов погоды в час
#define MAX_LEVEL_COLOR 85 // Уровень, при котором цвет максимальный

const char* ssid = "ИМЯ ВАШЕГО WIFI";
const char* password = "ПАРОЛЬ ВАШЕГО WIFI";
const String apiKey = "ВАШ API-КЛЮЧ";

const float lat = КООРДИНАТЫ ВАШЕГО ГОРОДА (ШИРОТА), НАПРИМЕР, 55.1544f;
const float lon = КООРДИНАТЫ ВАШЕГО ГОРОДА (ДОЛГОТА), НАПРИМЕР, 61.4297f;

Adafruit_NeoPixel strip(LED_COUNT, LED_PIN, NEO_GRB + NEO_KHZ800);
WiFiClient client;  

void setup() {
  Serial.begin(115200);
  strip.begin();
  strip.show();
  strip.setBrightness(BRIGHTNESS);  

  WiFi.begin(ssid, password);
  Serial.print("Connecting to WiFi");
  while (WiFi.status() != WL_CONNECTED) {
    wifiBreathingBlue(); // "дыхание" синим во время подключения
  }

  Serial.println("\nWiFi Connected!");
  Serial.println(WiFi.localIP());  

  // плавное включение зелёным после подключения
  startupFadeIn();
}

void loop() {
  Serial.println("Connecting to API...");
  float rainProb = getRainProbability9h();
  if (rainProb >= 0) {
    Serial.print("Вероятность дождя в ближайшие 9 часов: ");
    Serial.print(rainProb);
    Serial.println("%");
    
    // конвертируем вероятность в цвет
    uint8_t r = map(rainProb, 0, MAX_LEVEL_COLOR, 0, 255);
    if (r > 255) r = 255;
    uint8_t g = map(rainProb, 0, MAX_LEVEL_COLOR, 255, 0);
    if (g > 255) g = 255;
    showColor(r, g, 0); // от зелёного к красному
  } else {
    Serial.println("Error fetching rain probability!");
  }

  delay(60UL * 60UL * 1000UL / NUMBER_OF_REQUESTS); // обновление
}

// Плавная смена цвета
void fadeToColor(uint8_t rNew, uint8_t gNew, uint8_t bNew, int steps, int delayMs) {
  uint32_t current = strip.getPixelColor(0);
  uint8_t rCur = (current >> 16) & 0xFF;
  uint8_t gCur = (current >> 8) & 0xFF;
  uint8_t bCur = current & 0xFF;
  for (int i = 0; i <= steps; i++) {
    uint8_t r = rCur + (rNew - rCur) * i / steps;
    uint8_t g = gCur + (gNew - gCur) * i / steps;
    uint8_t b = bCur + (bNew - bCur) * i / steps;
    showColor(r, g, b);
    delay(delayMs);
  }
}

// Вывод цвета на всю ленту
void showColor(uint8_t r, uint8_t g, uint8_t b) {
  for (int i = 0; i < LED_COUNT; i++) {
    strip.setPixelColor(i, strip.Color(r, g, b));
  }
  strip.show();
}

// Плавное "включение" зелёным после подключения
void startupFadeIn() {
  for (int i = 0; i <= 100; i++) {
    uint8_t brightness = map(i, 0, 100, 0, 255);
    showColor(0, brightness, 0);
    delay(30);
  }
}

// Плавное "дыхание" синим при подключении
void wifiBreathingBlue() {
  static int brightness = 0;
  static int direction = 1;
  brightness += direction * 5;
  if (brightness >= 255) { brightness = 255; direction = -1; }
  if (brightness <= 0)   { brightness = 0; direction = 1; }
  showColor(0, 0, brightness);
  delay(20); // ~3 сек цикл
}

// Получение средней вероятности осадков на ближайшие 9 часов
float getRainProbability9h() {
  if (WiFi.status() != WL_CONNECTED) return -1;
  HTTPClient http;
  String url = "http://api.openweathermap.org/data/2.5/forecast?lat=" + String(lat, 6) + "&lon=" + String(lon, 6) + "&cnt=3&appid=" + apiKey + "&units=metric";
  if (!http.begin(client, url)) {
    Serial.println("HTTP begin failed");
    return -1;
  }
  
  unsigned long start = millis();
  int httpCode = http.GET();  

  // ждем минимум 10 секунд
  while (millis() - start < 10000) delay(50);
  if (httpCode == 200) {
    String payload = http.getString();
    if (payload.length() == 0) { http.end(); return -1; }
    StaticJsonDocument<2048> doc;
    DeserializationError error = deserializeJson(doc, payload);
    if (error) {
      Serial.print("JSON error: "); Serial.println(error.c_str());
      http.end();
      return -1;
    }
    float sumPop = 0;
    for (int i = 0; i < 3; i++) {
      sumPop += doc["list"][i]["pop"].as<float>();
    }
    http.end();
    return sumPop / 3.0 * 100.0;
  } else {
    Serial.print("HTTP code: "); Serial.println(httpCode);
    http.end();
    return -1;
  }
}
```
В коде нужно указать имя и пароль Wi-fi сети:
```
const char* ssid = "ИМЯ ВАШЕГО WIFI";
const char* password = "ПАРОЛЬ ВАШЕГО WIFI";
```
скопированный API-ключ:
```
const String apiKey = "ВАШ API-КЛЮЧ";
```
широту и долготу той точки на планете, погода в которой нас интересует:
```
const float lat = КООРДИНАТЫ ВАШЕГО ГОРОДА (ШИРОТА), НАПРИМЕР, 55.1544f;
const float lon = КООРДИНАТЫ ВАШЕГО ГОРОДА (ДОЛГОТА), НАПРИМЕР, 61.4297f;
```
Также по желанию можно настроить:
```
#define BRIGHTNESS 200 // Яркость светодиодов, макс 255
#define NUMBER_OF_REQUESTS 1 // Количество запросов погоды в час
#define MAX_LEVEL_COLOR 85 // Уровень, при котором цвет максимальный
```
уровень яркости светодиодов понижен с 255 до 200 (примерно на 20%) для большей долговечности светодиодов и во избежание перегрева светильника, т.к. уже при таком уровне яркости кольцо разогревается до 35 градусов при продолжительной работе, а пластик PETG очень не любит высокой температуры.
## Шаг 2: загрузка прошивки в контроллер
Подключаем контроллер ESP-01s с помощью программатора CH340G в USB-порт компьютера:

<img width="500" height="500" alt="Погодный светильник (подключение ESP-01s)" src="https://github.com/user-attachments/assets/15ffc293-1b55-4a5a-bd0e-27f5a4ee456d" />

Внешний вид программатора CH340G:

<img width="386" height="270" alt="Программатор для ESP-01s" src="https://github.com/user-attachments/assets/eb7784fc-9d46-4403-8a00-a777db700f1f" />

В программе Arduino IDE нам понадобится установить несколько библиотек: 
- ESP8266WiFi
- ESP8266HTTPClient
- Adafruit_NeoPixel
- ArduinoJson
- esp8266

В программе Arduino IDE в списке плат выбираем Generic ESP8266 Module:

<img width="800" height="800" alt="Погодный светильник (выбор платы ESP-01s)" src="https://github.com/user-attachments/assets/d510639e-fb33-4da2-a905-decc93f1f5be" />

Загружаем прошивку на контроллер:

<img width="380" height="275" alt="Погодный светильник (загрузка прошивки)" src="https://github.com/user-attachments/assets/85c9632a-4a1b-4df0-bb60-7e77a60ef34b" />

Когда загрузка будет выполнена, в мониторе порта Arduino IDE можно будет увидеть полученный прогноз:

<img width="923" height="242" alt="Погодный светильник (полученный прогноз в мониторе порта)" src="https://github.com/user-attachments/assets/c8da7a89-6281-4f3b-bea6-8063351427bf" />

## Шаг 3: подключение электроники
Далее подключаем всю электронику: контроллер ESP-01s, модуль LED, кольцо LED и блок питания на 5 В (на этом этапе можно использовать зарядник от телефона, я сделал тестовое подключение на регулируемом блоке питания). 
Сверху ESP-01s, снизу модуль LED:

<img width="381" height="370" alt="ESP-01s и LED-модуль" src="https://github.com/user-attachments/assets/adc74fbf-b1cc-4677-9237-94e13dfc38b8" />

Кольцо LED:

<img width="195" height="216" alt="Кольцо WS2812" src="https://github.com/user-attachments/assets/2ebf3323-c717-4afb-a8f9-b61f414215db" />

Гнездо USB-C (мама):

<img width="93" height="141" alt="Гнездо USB-C" src="https://github.com/user-attachments/assets/0907c971-dc48-49fb-8f2e-3f65d2ef6f32" />

Схема подключения:

| Модуль LED | Кольцо LED |
| ---------- | ---------- |
| VCC        | 5V         |
| GND        | GND        |
| SIG        | DI         |

В свою очередь модуль LED подключается к блоку питания по схеме:

| Блок питания | Модуль LED |
| ------------ | ---------- |
| +            | VCC        |
| -            | GND        |

<img width="600" height="600" alt="Погодный светильник (подключение модуля LED)" src="https://github.com/user-attachments/assets/33a5b887-34f3-4f67-9677-4d8aedf28e36" />

Следом подключаем контроллер ESP-01s в модуль LED. **ВНИМАНИЕ!** Контроллер должен быть направлен в сторону стрелки на модуле LED (см. ниже):

<img width="328" height="177" alt="Погодный светильник (установка ESP-01s)" src="https://github.com/user-attachments/assets/ff39a5fb-bcf9-4b4b-ab47-5feb3de3b07c" />

Проверяем: после подачи питания контроллер начинает подключаться к Wi-fi сети (кольцо в процессе мигает синим цветом), когда подключение установлено кольцо плавно загорается зеленым. Через 3-5 сек, получив данные о погоде от https://openweathermap.org/ будущий светильник должен изменить цвет в зависимости от полученных данных.

![Погодный светильник (первое включение)](https://github.com/user-attachments/assets/78efa0b6-18ec-4a08-9757-bdbad923278b)

## Результаты тестов прототипа

| Испытуемый параметр                  | Нормативное значение                                          | Полученное значение                                                             | Заключение |
| ------------------------------------ | ------------------------------------------------------------- | ------------------------------------------------------------------------------- | ---------- |
| Температура нагрева                  | не более 60 град                                              | 35 град                                                                         | +          |
| Читаемость информации                | различимым должно быть не менее 5 уровней вероятности осадков | совершенно четко можно различить зеленый, салатовый, желтый, оранжевый, красный | +          |
| Отвалы сети, зацикливания при работе | отсутствуют в месте эксплуатации                              | не зафиксировано                                                                | +          |
| Шумы (мерцания, посторонние звуки)   | отсутствуют                                                   | отсутствуют                                                                     | +          |

Измеренная электрическая мощность: 2,5 Вт.

**Вывод**: тестируемый прототип в полной мере удовлетворяет всем предъявляемым требованиям.
# 7. Проектирование продукта
## 7.1 Расчеты
**Выбор сечений кабеля**.
Испытания прототипа показали электрическую мощность в 2,5 Вт или 0,5 А при 5 В. По справочной таблице получаем минимальное сечение кабеля питания 30AWG. Для сигнального кабеля берем аналогичное сечение.
## 7.2 3D-модель
Модель корпуса светильника разделена на 3 части:
- опора;
- кольцо;
- крышка днища.

Внутрь кольца устанавливается кольцо светодиодов, кабель от которых проходит внутри опоры к ее нижней части, где установлены модуль LED с ESP-01s и гнездо USB-C:

<img width="609" height="684" alt="Погодный светильник (3D-модель)" src="https://github.com/user-attachments/assets/cab7040f-4e8e-426d-b77e-cbbd1af96d4d" />

**Кольцо** будем приклеивать к **опоре**, чтобы облегчить печать и не печатать сложные ветвистые поддержки. В месте стыка необходимо сразу смоделировать поверхности под приклейку так, чтобы площадь стыка обеспечивала необходимую прочность всей конструкции. 
**Крышка днища** будет устанавливаться в натяг. Небольшой полукруглый вырез в ней позволит при необходимости снять крышку, подцепив ее в этом месте плоской отверткой.
**Рассеиватель** также будет устанавливаться в натяг внутрь **кольца**. **Кольцо LED** зажато между **рассеивателем** и **кольцом**.
# 8. Изготовление опытного образца
## Шаг 1: печать корпуса

![Погодный светильник (печать)](https://github.com/user-attachments/assets/afb77c99-9170-415f-ba76-b9c549b5a666)

Я предполагал печатать опору единой деталью, но мой принтер (Adventurer 5m) подкинул мне неожиданный сюрприз в виде ошибки E0017: *переполнение очереди перемещений*. Т.к. деталь полностью состоит из криволинейных поверхностей происходит переполнение буфера и принтер останавливается примерно на 70% детали. При попытке перезапустить процесс и продолжить с того же места принтер пропустил один слой и попытался напечатать следующий висящим в воздухе. Не страшно, разобъем опору на две детали и склеим их.
Печать остальных деталей прошла без замечаний.

<img width="473" height="817" alt="Погодный светильник (место стыка деталей)" src="https://github.com/user-attachments/assets/e0331c7d-16f3-4377-8834-59a3390410b4" />

## Шаг 2: сборка
Сначала собираем верхнюю часть: кольцо, кольцо LED и рассеиватель. Припаиваем провода:

<img width="600" height="600" alt="Погодный светильник (сборка верхней части)" src="https://github.com/user-attachments/assets/c3bb6160-2da8-479c-be52-f2b8044cf06c" />

Следом собираем нижнюю часть: контроллер с модулем LED и гнездом USB-C:

<img width="658" height="360" alt="Погодный светильник (сборка нижней части)" src="https://github.com/user-attachments/assets/5d5ea5e5-5f31-44d1-83b9-42015b8faf2c" />

Проверяем, что все подключено правильно:

![Погодный светильник (проверка электроники)](https://github.com/user-attachments/assets/b13d7544-2171-4917-919e-8c08c4049178)

Устанавливаем электронику в опору и закрываем крышкой днища. Склеиваем верхнюю и нижнюю части корпуса светильника. В качестве клея использован Космофен.
**Изделие готово**:

<img width="606" height="800" alt="Погодный светильник (готовый)" src="https://github.com/user-attachments/assets/e62c224d-242c-4b67-87ff-b38d8d8ce7b0" />

# 9. Испытание опытного образца (верификация)
Перечень требований к изделию приведены в п.2 "Технические требования к изделию". Невыполненные требования:

| Требование                                                                                                             | Текущее значение                                              | Почему не выполнено                                                                                                                                                                | Дальнейшие действия |
| ---------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------- |
| Точность отображаемой информации ( использовать несколько источников информации и усреднять полученные с них значения) | использован единственный источник https://openweathermap.org/ | 1. большинство ресурсов с погодой - платные, что противоречит требованию "бесплатности" эксплуатации;<br>2. высокая сложность кода;<br>3. ограниченные ресурсы памяти контроллера. | принять допустимым  |
| Эстетический внешний вид                                                                                               | внешний вид немного портит место стыка на "ножке"             | из-за ограничений возможностей принтера (см. п.[[#8. Изготовление опытного образца]]). Есть основания полагать, что переделка смотрелась бы примерно также.                        | принять допустимым  |
| Ненавязчивость (не напоминает о себе когда не требуется)                                                               | сам светильник работает постоянно, пока подается питание      | светильник подключен в "умную" розетку, которая отключается на ночь и когда никого нет дома                                                                                        | допустимо           |
| Информация об осадках отображается за 3 выбранных периода времени                                                      | один период в 9 часов                                         | выбран более простой в реализации концепт                                                                                                                                          | допустимо           |

**Вывод**: опытный образец признан годным.
# 10. Ретроспектива ошибок
## Ошибка 1: недостаток жесткости печатаемой детали
Первая версия опоры была сильно тоньше финальной, из-за чего ей серьезно не хватало жесткости при печати и голова 3D-принтера "шатала" верхнюю часть, увлекая ее при движениях за собой. Так верхняя часть опоры выходила неприемлемого качества, пришлось сделать ее сечение "массивней".
Кстати, именно увеличение сечения опоры привело к возникновению той самой ошибки с переполнением буфера принтера.

<img width="800" height="701" alt="Погодный светильник (ошибка печати 1)" src="https://github.com/user-attachments/assets/c13c73a6-d526-47bc-a95b-65be99af127f" />

## Ошибка 2: перегорание электроники
Ошибка из-за невнимательности: в схеме нет защиты от переплюсовки и, перепутав + с -, я сжег модуль LED. Пришлось оперативно заказывать новый.
## Ошибка 3: несогласованные логические уровни 
Когда я сжег первый модуль LED, я попытался исправить ситуацию и изготовив плату самостоятельно. Но в тот момент не имел понятия, что светодиоды WS2812 управляются напряжением от 3,5 В (логическая единица для них более 0,7хVcc=**3.5 В**), а так как контроллер ESP-01s выдает сигнал напряжением 3,3 В, то управление оказывается крайне нестабильным. До сборки платы я проверил работоспособность такого способа и, как ни парадоксально, но схема заработала. Собрав плату и подключив ее к нормальному блоку питания, я с удивлением обнаружил, что работать она отказалась (светился только первый светодиод). Как выяснилось, моя тестовая сборка питалась от 4,4-4,6 В и сигнального напряжения 3,3 В светодиодам хватало для того, чтобы отличить его от логического нуля (0,7х4,5=**3,15 В** < 3.3В). А вот со стабильным напряжением 5 В уже возникла проблема.
Чтобы не городить драйвер или иное согласование уровней, я решил дождаться еще одного модуля LED.
Незаработавшая плата:

<img width="653" height="624" alt="Погодный светильник (нерабочая плата)" src="https://github.com/user-attachments/assets/d5102758-1c6c-4d4a-9274-e9394cc2006a" />

# Итоговый результат
Вот-вот начнется дождь:

<img width="541" height="907" alt="Погодный светильник (результат)" src="https://github.com/user-attachments/assets/7320bea6-c4f9-4840-97b9-8ad90a4fca77" />

# Заключение
В данном проекте мы прошли почти весь путь разработки продукта, как он происходит в машиностроительных и приборостроительных компаниях. Почти, потому что нам в данном проекте не требовалось разрабатывать документацию, упаковку для продукта, сертификацию, адаптацию изделия для производства и т.д. Данная методика хорошо подходит для **DIY-проектов** и **создания MVP** будущего продукта.
**До новых встреч!**

## Исходники
3D-модель:
[Погодный светильник (3D-модель).zip](https://github.com/user-attachments/files/24015429/3D-.zip)

Код:
[Weather_lamp_code.zip](https://github.com/user-attachments/files/24015435/Weather_lamp_code.zip)

## Рекомендуемая литература по теме:
- Карл Ульрих, Стивен Эппингер "Промышленный дизайн. Создание и производство продукта".
- Дэн Олсен "MVP. Как выводить на рынок товары и услуги, которые нравятся покупателям".
